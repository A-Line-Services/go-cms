# A-Line CMS Go SDK

A Go/[templ](https://templ.guide) framework for building static sites powered by [A-Line CMS](https://a-line.be). Define pages with templ components, register CMS-editable fields inline, and get a production-ready static site with live preview, image optimisation, and one-command deployment.

```
go get go.a-line.be/cms
```

## Quick start

### 1. Create a project

```bash
mkdir mysite && cd mysite
go mod init github.com/you/mysite
go get go.a-line.be/cms
```

### 2. Write a page

Create `pages/index.templ`:

```templ
package pages

import (
    cms "go.a-line.be/cms"
    c   "go.a-line.be/cms/components"
)

templ content(p cms.PageData) {
    @c.Meta("homepage", "Homepage")
    <h1>@c.Text(p, "title", "Title", "Welcome")</h1>
    @c.Image(p, "hero", "Hero Image", cms.ImageValue{Alt: "Hero"})
    @c.RichText(p, "body", "Body", "<p>Hello world.</p>")
}

templ IndexPage(p cms.PageData) {
    <!DOCTYPE html>
    <html lang={ p.Locale }>
        <head>
            <meta charset="UTF-8"/>
            @c.SEOHead(p)
        </head>
        <body>@content(p)</body>
    </html>
}
```

### 3. Bootstrap

Create `main.go`:

```go
package main

import (
    "os"
    cms "go.a-line.be/cms"
)

func main() {
    app := cms.NewApp(cms.Config{
        APIURL:   os.Getenv("CMS_API_URL"),
        SiteSlug: os.Getenv("CMS_SITE_SLUG"),
        APIKey:   os.Getenv("CMS_API_KEY"),
        Locale:   "en",
    })
    RegisterRoutes(app)
    app.Run()
}
```

### 4. Generate, build, and serve

```bash
templ generate              # compile .templ to Go
go run . generate           # scan pages/ and write routes_gen.go
go run . build              # build static HTML + sync.json
go run . serve              # serve dist/ on :8080
```

Or in development:

```bash
go run . dev                # dev server on :3000 with live preview support
```

---

## Configuration

Pass a `Config` to `NewApp`:

```go
cms.Config{
    APIURL   string   // CMS API base URL  (e.g. "https://cms.a-line.be")
    SiteSlug string   // your site slug     (e.g. "my-site")
    APIKey   string   // public API key
    Locale   string   // default locale     (default: "en")
}
```

These are typically read from environment variables. See `.env.example`:

```env
CMS_API_URL=http://localhost:8000
CMS_SITE_SLUG=your-site-slug
CMS_API_KEY=your-api-key-here
CMS_LOCALE=en
```

---

## CLI commands

All commands are dispatched by `app.Run()` based on the first argument:

| Command | Description |
|---|---|
| `generate` | Scan `pages/` and write `routes_gen.go` |
| `build` | Build static HTML **and** `sync.json` to `dist/` |
| `build static` | Build static HTML only |
| `build sync` | Build `sync.json` only |
| `serve` | Serve `dist/` on `:8080` (or `PORT` env) |
| `sync` | Build sync payload and POST it to the CMS API |
| `dev` | Dev server on `:3000` with auto-sync, rebuild endpoint, and live preview |

### Flags

```
generate  -pages pages  -out routes_gen.go  -package main
build     -out dist     -sync-file sync.json  -media  -minify
serve     -dir dist     -port 8080
dev       -port 3000    -out .dev-dist
```

---

## File-based routing

The `generate` command scans your `pages/` directory and creates a `routes_gen.go` file that registers all routes automatically.

### Conventions

| File | URL | Type |
|---|---|---|
| `pages/index.templ` | `/` | Page |
| `pages/about.templ` | `/about` | Page |
| `pages/contact-us.templ` | `/contact-us` | Page |
| `pages/blog/index.templ` | `/blog` | Listing (when `entry.templ` exists) |
| `pages/blog/entry.templ` | `/blog/:slug` | Entry |
| `pages/layout.templ` | *(ignored)* | Shared layout |
| `pages/_partial.templ` | *(ignored)* | Underscore prefix = skip |

Function names are derived from filenames: `index.templ` exports `IndexPage`, `about.templ` exports `AboutPage`, `contact-us.templ` exports `ContactUsPage`.

### Generated output

```go
// Code generated by go-cms generate -- DO NOT EDIT.
package main

import (
    cms "go.a-line.be/cms"
    "github.com/you/mysite/pages"
    "github.com/you/mysite/pages/blog"
)

func RegisterRoutes(app *cms.App) {
    app.Page("/", pages.IndexPage)
    app.Page("/about", pages.AboutPage)
    app.Collection("/blog", "Blog", blog.IndexPage, blog.EntryPage)
}
```

---

## Page templates

Every page is a `RenderFunc` -- a function that takes `PageData` and returns a `templ.Component`:

```go
type RenderFunc func(PageData) templ.Component
```

### Field accessors

`PageData` provides typed accessors for CMS field values:

| Method | Returns | Zero value |
|---|---|---|
| `Text(key)` | `string` | `""` |
| `TextOr(key, fallback)` | `string` | fallback |
| `RichText(key)` | `template.HTML` | `""` |
| `RichTextOr(key, fallback)` | `template.HTML` | fallback |
| `Image(key)` | `ImageValue` | empty |
| `ImageOr(key, fallback)` | `ImageValue` | fallback |
| `Video(key)` | `string` | `""` |
| `URL(key)` | `string` | `""` |
| `URLOr(key, fallback)` | `string` | fallback |
| `Number(key)` | `float64` | `0` |
| `NumberOr(key, fallback)` | `float64` | fallback |
| `Currency(key)` | `CurrencyValue` | `{0}` |
| `SEO()` | `SEOData` | empty |
| `Subcollection(key)` | `[]EntryData` | `nil` |
| `SubcollectionOr(key)` | `[]EntryData` | 1 empty entry (template) or actual data (production) |
| `Listing(key)` | `[]PageData` | `nil` |

---

## Components

Import the component package:

```go
import c "go.a-line.be/cms/components"
```

All components emit `data-cms-*` HTML attributes so the CMS can discover fields and enable live editing. In production builds, these attributes are automatically stripped.

### Text

```templ
@c.Text(p, "title", "Page Title", "Default Title")
@c.TextBlock(p, "bio", "Biography", "Short bio here")     // renders <div> instead of <span>
@c.TextRequired(p, "title", "Title", "Untitled")           // marks field as required
@c.TextEntry(entry, "name", "Name", "Default Name")        // for subcollection entries
```

### Rich text

```templ
@c.RichText(p, "body", "Main Content", "<p>Default content</p>")
@c.RichTextEntry(entry, "bio", "Bio", "<p>About this person</p>")
```

### Image

```templ
// Full responsive image: AVIF/WebP sources, srcset, LQIP placeholder
@c.Image(p, "hero", "Hero Image", cms.ImageValue{Alt: "Hero banner"})
@c.ImageEntry(entry, "photo", "Photo", cms.ImageValue{Alt: "Photo"})

// Plain <img> tag (no srcset, no LQIP)
@c.ImageSimple(p, "logo", "Logo", cms.ImageValue{Alt: "Logo"})

// Fixed display size (generates srcset for 0.5x-2x of the given width)
@c.ImageSized(p, "avatar", "Avatar", 120, cms.ImageValue{Alt: "Avatar"})

// Clickable image with a separate URL field
@c.ImageLink(p, "banner", "Banner", "banner_url", cms.ImageValue{Alt: "Banner"}, "/")

// Display-only (no CMS attributes, for listings)
@c.ImageCard(post.ImageOr("cover", cms.ImageValue{Alt: "Cover"}))
```

### Link

```templ
@c.Link(p, "cta", "Call to Action", "/contact") {
    Get in touch
}
@c.LinkEntry(entry, "url", "Website", "https://example.com") {
    @c.ImageEntry(entry, "logo", "Logo", cms.ImageValue{Alt: "Logo"})
}
```

### Video

```templ
@c.Video(p, "demo", "Demo Video", "https://youtube.com/watch?v=...")
```

### Number & Currency

```templ
@c.Number(p, "rating", "Rating", 4.5)
@c.Currency(p, "price", "Price", 29.00)
@c.NumberEntry(entry, "quantity", "Qty", 1)
@c.CurrencyEntry(entry, "cost", "Cost", 0)
```

### SEO

```templ
// In your <head>: renders <title>, meta description, Open Graph tags
@c.SEOHead(p)
```

### Meta

```templ
// Declare which CMS template this page uses (required for sync)
@c.Meta("homepage", "Homepage")

// For collection entry pages
@c.CollectionMeta("blog-post", "Blog Post", "blog", "Blog")
```

---

## Subcollections

Subcollections are repeatable groups of fields (e.g. team members, partners, FAQ items).

### Template

```templ
<div data-cms-subcollection="team" data-cms-label="Team Members">
    for _, member := range p.SubcollectionOr("team") {
        <div data-cms-entry>
            @c.ImageEntry(member, "photo", "Photo", cms.ImageValue{Alt: "Photo"})
            <h3>@c.TextEntry(member, "name", "Name", "Name")</h3>
            <span>@c.TextEntry(member, "role", "Role", "Role")</span>
        </div>
    }
</div>
```

### How it works

- Wrap the repeating section in an element with `data-cms-subcollection="key"`.
- Each item gets `data-cms-entry`.
- Use `EntryData` accessors (`TextEntry`, `ImageEntry`, etc.) for fields inside entries.
- `SubcollectionOr("key")` returns one empty fallback entry during template rendering (so the CMS can discover the schema) and real data in production.

### Nesting

Subcollections can be nested. Use `entry.SubcollectionOr("child_key")` inside an entry loop.

---

## Collections

Collections are blog-style dynamic pages where each entry gets its own URL.

### Registration

```go
app.Collection("/blog", "Blog", blog.IndexPage, blog.EntryPage)
```

Or via file-based routing: place `index.templ` and `entry.templ` in the same directory.

### Listing page

Use `p.Listing("key")` to iterate over published entries:

```templ
for _, post := range p.Listing("blog") {
    <a href={ templ.SafeURL(post.Path) }>
        <h3>{ post.TextOr("title", "Untitled") }</h3>
    </a>
}
```

### Entry page

Mark the template with `CollectionMeta`:

```templ
@c.CollectionMeta("blog-post", "Blog Post", "blog", "Blog")
<h1>@c.TextRequired(p, "title", "Title", "Untitled")</h1>
@c.Image(p, "cover", "Cover", cms.ImageValue{Alt: "Cover"})
@c.RichText(p, "content", "Content", "<p>Write here...</p>")
```

---

## Images

`ImageValue` provides responsive image handling:

```go
type ImageValue struct {
    URL string
    Alt string
}
```

### Methods

| Method | Description |
|---|---|
| `Src(opts...)` | Primary URL, optionally resized via `Width()`, `Height()`, `Quality()`, `Format()` |
| `SrcSet(widths...)` | Responsive srcset string (default widths: 400, 800, 1200, 1600) |
| `SrcSetFor(format, widths...)` | Srcset for a specific format (e.g. `"avif"`, `"webp"`) |
| `HasFormat(format)` | Whether the image has a resolved URL for the given format |
| `LQIP()` | Low-quality image placeholder (base64 data URI, 32px wide) |

### Media options

When calling `Src()` directly:

```go
img.Src(cms.Width(800), cms.Quality(80), cms.Format("webp"))
```

### Build-time optimisation

When building with `-media` (default), the build system:

1. Downloads all image variants (multiple widths + AVIF/WebP formats)
2. Generates LQIP placeholders as inline base64 data URIs
3. Saves to `dist/media/` with content-hashed filenames
4. Rewrites image URLs in the output HTML to local paths

---

## Email templates

Register email templates for transactional emails managed through the CMS:

```go
app.EmailTemplate(
    "welcome",                      // key
    "Welcome Email",                // label
    "Welcome to {{company}}!",      // subject (supports variables)
    "<html>...</html>",             // HTML body
    []cms.EmailVariable{
        {Key: "company", Description: "Company name", SampleValue: "Acme"},
        {Key: "name", Description: "User's first name", SampleValue: "Alice"},
    },
)
```

---

## Build output

The `build` command produces:

```
dist/
  index.html                  # production HTML (clean, no CMS attributes)
  index.template.html         # template HTML (CMS attributes preserved)
  about/index.html
  about/index.template.html
  blog/index.html
  blog/index.template.html
  blog/_template/index.html   # collection entry template
  blog/my-first-post/index.html
  media/                      # downloaded & optimised images
  sync.json                   # sync payload for CMS
```

- **Production HTML** (`index.html`): all `data-cms-*` attributes and `<meta name="cms-*">` tags are stripped. Minified when `-minify` is enabled.
- **Template HTML** (`index.template.html`): preserves CMS attributes. Used by the dev server for live preview (served when `X-CMS-Preview: true` header is present).

---

## Dev server

```bash
go run . dev
```

The dev server:

1. Runs an initial sync to register templates/fields with the CMS
2. Builds all pages to `.dev-dist/`
3. Serves on `:3000` (or `PORT` env)
4. Serves `.template.html` files when the `X-CMS-Preview: true` header is present (used by the CMS editor's live preview)
5. Exposes `POST /rebuild` to trigger a rebuild

---

## Example

See [`examples/basic/`](examples/basic/) for a complete example with:

- Homepage with text, images, rich text, currency, and a partners subcollection
- About page with a team members subcollection
- Blog with listing and entry pages
- Shared layout

```bash
cd examples/basic
cp .env.example .env        # fill in your CMS credentials
templ generate && go run . generate
go run . dev
```

---

## License

Proprietary. Copyright A-Line Services.
